---
layout: post
title: "ffmpegç¬”è®°"
categories: ffmpegåˆ†æ
---

## å‘½ä»¤è¡Œ

#### ffmpeg
- [Wiki](http://trac.ffmpeg.org/wiki)
- [Documentation](https://ffmpeg.org/ffmpeg-all.html)

###### å¸¸ç”¨
- è½¬æˆæ¥è¿‘CBR

```bash
ffmpeg -i file.mp4 -c:v libx264 -g 50 -c:a aac -b 35m -maxrate 35m -minrate 35m -bufsize 35m -crf 22 file_cbr_35M.ts
```

- aacè½¬ä¸ºPCM

```bash
ffmpeg -i file.acc -f s16le file.pcm
```

- æ–‡ä»¶è½¬udpç»„æ’­æµ

```bash
ffmpeg -stream_loop -1 -re -i 8M.ts -codec copy -f mpegts -pkt_size 1316 -localaddr 192.168.10.194 udp://225.5.5.5:18600
```

- seeking and cutting

```bash
ffmpeg -ss <start> -i <input> -t <duration> -c copy <output>
ä»startå¼€å§‹ï¼Œåˆ‡durationæ—¶é•¿
``` 

```bash
ffmpeg -ss <start> -i <input> -to <end> -c copy <output>
ä»startå¼€å§‹ï¼Œåˆ‡åˆ°end
``` 

###### ç¼–ç 

ç¼–ç è´¨é‡
CRF [Constant Rate Factor](https://slhck.info/video/2017/02/24/crf-guide.html)ï¼Œå…¨ç¨‹æ§åˆ¶ç¼–ç è´¨é‡ï¼Œ18-28æ•ˆæœå°šä½³ï¼Œè¶Šä½è¶Šå¥½

```bash
ffmpeg -i <input> -c:v libx264 -crf 23 -c:a aac -b:a 128k output.mkv
```

ç¼–ç é€Ÿåº¦
presetï¼šultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow

```bash
ffmpeg -i <input> -c:v libx264 -crf 23 -preset ultrafast -an output.mkv
```

```bash
ffmpeg -i <input> -c:v libx264 -crf 23 -preset medium -an output.mkv
```

```bash
ffmpeg -i <input> -c:v libx264 -crf 23 -preset veryslow -an output.mkv
```

å¸§ç‡

```bash
ffmpeg -i <input> -r 24 <output>
```

ç‡æ§
[Understanding Rate Control Modes (x264, x265, vpx)](https://slhck.info/video/2017/03/01/rate-control.html)
- Constant Bitrate(CBR)
- Variable Bitrate(VBR)
- - Average bitrate(ABR)
- - Constant quantization parameter(CQP)
- - Constant quality, based on psychovisual properties, e.g. CRF in x264/x265/libvpx-vp9
- - Constrained bitrate (VBV)

###### æµçš„æ˜ å°„
- 0:0 is the first stream of the first input file
- 0:1 is the second stream of the first input file
- 2:a:0 is the first audio stream of the third input file

```bash
ffmpeg -i input.mp4 -i input.m4a -c copy -map 0:v:0 -map 1:a:0 output.mp4
æ˜ å°„è¾“å…¥æµåˆ°è¾“å‡ºä¸­ï¼Œé€‰æ‹©ç¬¬0ä¸ªæ–‡ä»¶çš„è§†é¢‘æµ0å’Œç¬¬1ä¸ªæ–‡ä»¶çš„éŸ³é¢‘æµ0
```

###### filter

```bash
ffmpeg -i <input> -filter:v "<filter1>,<filter2>,<filter3>" <output>

-filter:v <name>=<option1>=<value1>:<option2>=<value2>
è®¾ç½®filterçš„å‚æ•°
``` 

- [scaling](https://slhck.info/ffmpeg-encoding-course/#/37)
- [padding](https://slhck.info/ffmpeg-encoding-course/#/38)
- [fading](hhttps://slhck.info/ffmpeg-encoding-course/#/39)
- [drawing text](https://slhck.info/ffmpeg-encoding-course/#/40)


#### ffprobe
- [Wiki](http://trac.ffmpeg.org/wiki/FFprobeTips)
- [Documentation](https://ffmpeg.org/ffprobe.html)

###### ä¸»è¦é€‰é¡¹

```bash
ffprobe <input>
    [-select_streams <selection>]
    [-show_streams|-show_format|-show_frames|-show_packets]
    [-show_entries <entries>]
    [-of <output-format>]

-show_entries       é€‰æ‹©æ‰“å°çš„æ¡ç›®
-pretty             ä½¿æ•°æ®çš„å±•ç¤ºæ›´æ˜“è¯»
-print_format format  è®¾ç½®è¾“å‡ºæ ¼å¼ (å¯é€‰æ ¼å¼æœ‰ï¼šdefault, compact, csv, flat, ini, json, xml)
-of format          alias for -print_format
-select_streams stream_specifier æŒ‡å®šæŸ¥çœ‹çš„æµ(v,a,s)
-show_data          å±•ç¤ºåŒ…å†…çš„å…·ä½“å†…å®¹
-show_format        å±•ç¤ºå®¹å™¨ä¿¡æ¯
-show_frames        å±•ç¤ºè§£ç åçš„å¸§ä¿¡æ¯
-show_packets       å±•ç¤ºè§£å°è£…åæ•°æ®åŒ…çš„ä¿¡æ¯
-show_programs      å±•ç¤ºèŠ‚ç›®ä¿¡æ¯
-show_streams       å±•ç¤ºæµä¿¡æ¯
``` 

###### å¸¸ç”¨
- å±•ç¤ºå¸§çš„æ—¶æˆ³ä¸ç±»å‹ï¼Œcsvæ ¼å¼

```bash
ffprobe <input> -show_frames -show_entries frame=pkt_pts,pkt_dts,media_type,pict_type -of csv=p=0
```

- æ¥æ”¶ç»„æ’­æµæ—¶è®¾ç½®æœ¬åœ°ip

```bash
ffprobe -show_packets udp://238.1.0.3:5000 -localaddr 172.16.233.169 -of csv
```


#### ffplay
- æ’­æ”¾pcmæ–‡ä»¶

```bash
ffplay -ar 44100 -ac 2 -f s16le .\file.pcm
```

- æ’­æ”¾rawæ–‡ä»¶

```bash
ffplay -f rawvideo -video_size 7680x4320 -pixel_format yuv420p10le -framerate 50 -fs .\file.raw
```

- æ˜¾ç¤ºh264è¿åŠ¨çŸ¢é‡

```bash
ffplay -flags2 +export_mvs input.mp4 -vf codecview=mv=pf+bf+bb
```


## åº“
#### libavformat
è¯»å†™å®¹å™¨ï¼ˆAVI,MKV,MP4...ï¼‰ 

#### libavcodec
è¯»å†™ç¼–è§£ç å™¨ï¼ˆh.264,h.265,VP9...ï¼‰

#### libavfilter
å¤šç§è¿‡æ»¤å™¨


## ffmpegæ¶æ„

![ffmpegæ¶æ„å›¾]({{ "/assets/image/ff_architecture.png" | relative_png}})

#### å®¹å™¨
`ffmpeg -formats` æŸ¥çœ‹æ”¯æŒçš„å®¹å™¨
###### å¸¸ç”¨å®¹å™¨
- MP4: MPEG-4 Part 14 container for H.264, H.264, AAC audio, â€¦
- MKV: Versatile container for any media format
- WebM: Subset of MKV, usage in Web streaming
- AVI: Legacy container

#### ç¼–è§£ç 
`ffmpeg -codec` æŸ¥çœ‹æ”¯æŒçš„ç¼–è§£ç æ ¼å¼

###### ä¸»è¦æœ‰æŸç¼–è§£ç æ ¼å¼

å¸¸ç”¨:
- ğŸ¥ H.262 / MPEG-2 Part H: Broadcasting, TV, used for backwards compatibility
- ğŸ¥ H.264 / MPEG-4 Part 10: The de-facto standard for video encoding today
- ğŸ¥ H.265 / HEVC / MPEG-H: Successor of H.264, up to 50% better quality
- ğŸ”Š MP3 / MPEG-2 Audio Layer III: Used to be the de-facto audio coding standard
- ğŸ”Š AAC / ISO/IEC 14496-3:2009: Advanced Audio Coding standard

å…æˆæƒ:
- ğŸ¥ VP8: Free, open-source codec from Google (not so much in use anymore)
- ğŸ¥ VP9: Successor to VP8, almost as good as H.265
- ğŸ¥ AV1: A successor to VP9, claims to be better than H.265

###### ä¸»è¦æ— æŸç¼–è§£ç æ ¼å¼
- ğŸ¥ Raw YUV, HuffYUV, FFV1, ffvhuff â€¦
- ğŸ”Š Raw PCM, FLAC, ALAC, â€¦
- ğŸ¥ Apple ProRes, Avid DNxHD, JPEG2000, high-quality H.264/H.265, ...
- High bitrate and usually only I-frames

###### ç¼–ç å™¨
`ffmpeg -encoders` æŸ¥çœ‹ffmpegæ”¯æŒçš„[ç¼–ç å™¨](https://slhck.info/ffmpeg-encoding-course/#/17)

###### åƒç´ æ ¼å¼
`ffmpeg -pix_fmts` æŸ¥çœ‹æ”¯æŒçš„[åƒç´ æ ¼å¼](https://slhck.info/ffmpeg-encoding-course/#/19)

## å­¦ä¹ èµ„æ–™

#### é›·ç¥çš„ä¾‹å­
[Lei Xiaohua's learning resource about video/audio technics](http://leixiaohua1020.github.io/#ffmpeg-development-examples)

#### Werner Robitzaçš„è¯¾ç¨‹
[FFMPEG ENCODING AND EDITING COURSE](https://slhck.info/ffmpeg-encoding-course/#/)

#### github
https://github.com/leandromoreira/ffmpeg-libav-tutorial

## ç æµåˆ†æå·¥å…·
[Elecard Stream Analyzer](https://www.elecard.com/products/video-analysis/stream-analyzer)
[CodecVisa](http://www.codecian.com/)
[Intel Video Pro Analyzer](https://www.intel.com/content/www/us/en/developer/articles/tool/video-pro-analyzer.html)
[AOMAnalyzer](https://people.xiph.org/~mbebenita/analyzer/)